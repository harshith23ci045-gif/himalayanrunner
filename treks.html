<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Treks - Himalayan Runners</title>
  <link rel="stylesheet" href="/css/treks-ui.css" />
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body>
  <header class="page-header">
      <h2>Himalayan Treks</h2>
  </header>

  <section class="trek-filter-bar">
      <button class="filter-btn active">Himalayan Treks</button>
      <button class="filter-btn">Sunrise Treks</button>
      <button class="filter-btn">Weekend Treks</button>
  </section>

  <main class="trek-container">
      <div id="trekList" class="trek-grid"></div>
  </main>

  <script type="module">
    import { supabase } from "./js/supabase-client.js";
    import { listTreks } from "./js/trek-handler.js";
    import { createRazorpayOrder, openRazorpayCheckout } from "./js/razorpay-client.js";

    const RAZORPAY_KEY_ID = "REPLACE_WITH_RAZORPAY_KEY_ID";
    const trekListEl = document.getElementById("trekList");

    async function fetchAndRender() {
      const { data } = await listTreks();

      trekListEl.innerHTML = data.map(t => `
        <div class="trek-card">
            <div class="trek-img">
                <img src="${t.image_url || '/images/default-trek.jpg'}" />
                <span class="tag">Himalayan-treks</span>
            </div>

            <div class="trek-body">
                <h3>${t.trek_name}</h3>

                <div class="trek-info">
                    <p>üìç Himalayan</p>
                    <p>üóì ${t.days || '5 days'}</p>
                </div>

                <p class="trek-desc">${t.description ?? ''}</p>

                <div class="trek-price-row">
                    <span class="price">‚Çπ${t.price}</span>
                </div>

                <button class="pay-btn" data-id="${t.id}" data-price="${t.price}">
                    Book Now ‚Üí
                </button>
            </div>
        </div>
      `).join("");

      document.querySelectorAll(".pay-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
          const trekId = btn.dataset.id;
          const price = Number(btn.dataset.price);

          const order = await createRazorpayOrder(price);
          const user = (await supabase.auth.getUser()).data.user;

          const res = await openRazorpayCheckout(order, RAZORPAY_KEY_ID, {
            prefill: { email: user.email },
            description: "Trek booking",
          });

          await supabase.from("bookings").insert([
            { trek_id: trekId, user_id: user.id, amount_paid: price, payment_id: res.razorpay_payment_id }
          ]);

          alert("Payment successful!");
        });
      });
    }

    fetchAndRender();
  </script>

</body>
</html>
