<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guide Dashboard - Himalayan Runners</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="loadingIndicator"
        style="position: fixed; top: 0; left: 0; right: 0; background: #1976d2; color: white; padding: 10px; text-align: center; z-index: 1000; display: none;">
        Loading dashboard...
    </div>

    <div class="container" style="padding-bottom: 80px;">
        <div class="dashboard-header">
            <h1>Guide Dashboard</h1>
            <p id="guideName"></p>
            <button onclick="Auth.logout()" class="btn btn-outline"
                style="margin-top: 1rem; color: white; border-color: white;">Logout</button>
        </div>

        <div class="glass-card mb-2">
            <h3>Create New Trek</h3>
            <form id="createTrekForm" class="mt-2">
                <div class="form-group">
                    <input id="location" placeholder="Location" class="form-input" required>
                </div>
                <div class="form-group">
                    <input id="date" type="date" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary">Create Trek</button>
            </form>
        </div>

        <div class="flex justify-between align-center mb-2">
            <h3>Participants</h3>
            <button onclick="exportCSV()" class="btn btn-outline btn-small">Export CSV</button>
        </div>

        <div id="participants" class="grid"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="module">

        import { supabase } from "./js/supabase-client.js";
        import Auth from "./js/auth.js";

        let user;
        let myTreks = [];
        let participants = [];

        async function initDashboard() {
            const loader = document.getElementById("loadingIndicator");
            loader.style.display = "block";

            try {
                user = await Auth.requireAuth();
                if (!user) return;

                if (user.role !== "Trek Guide") {
                    alert("Access denied. Trek Guides only.");
                    window.location.href = "index.html";
                    return;
                }

                document.getElementById('guideName').textContent = user.full_name;

                await loadTreksAndParticipants();

            } catch (err) {
                console.error(err);
                alert("Error loading dashboard.");
                window.location.href = "login.html";
            }

            loader.style.display = "none";
        }

        async function loadTreksAndParticipants() {
            // LOAD GUIDE'S TREKS
            const { data: treks } = await supabase
                .from("treks")
                .select("*")
                .eq("guide_id", user.id);

            myTreks = treks || [];

            // LOAD REGISTRATIONS FOR THESE TREKS
            const trekIds = myTreks.map(t => t.id);

            const { data: regs } = await supabase
                .from("registrations")
                .select("*")
                .in("trek_id", trekIds);

            participants = regs || [];

            renderParticipants();
        }

        function renderParticipants() {
            const div = document.getElementById("participants");
            div.innerHTML = "";

            if (participants.length === 0) {
                div.innerHTML = `<p style="text-align:center;color:#666;">No participants yet.</p>`;
                return;
            }

            participants.forEach(p => {
                const trek = myTreks.find(t => t.id === p.trek_id);

                const card = document.createElement("div");
                card.className = "stat-card";

                card.innerHTML = `
                    <h4>Trek: ${trek?.location ?? "Unknown"}</h4>
                    <p>Trekker ID: ${p.trekker_id}</p>
                    <p>Status: <strong>${p.status}</strong></p>
                    ${
                        p.status !== "completed"
                        ? `<button class="btn btn-accent mt-1" onclick="markCompleted('${p.id}', '${p.trekker_id}')">Mark Completed</button>`
                        : ""
                    }
                `;
                div.appendChild(card);
            });
        }

        // CREATE TREK
        document.getElementById("createTrekForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const newTrek = {
                location: document.getElementById("location").value,
                date: document.getElementById("date").value,
                guide_id: user.id,
                status: "upcoming"
            };

            await supabase.from("treks").insert(newTrek);

            alert("Trek created!");
            document.getElementById("createTrekForm").reset();

            await loadTreksAndParticipants();
        });

        // MARK COMPLETED
        window.markCompleted = async function (regId, trekkerId) {

            await supabase
                .from("registrations")
                .update({ status: "completed" })
                .eq("id", regId);

            await supabase
                .from("profiles")
                .update({ trek_count: supabase.rpc("increment_treks", { uid: trekkerId }) });

            alert("Marked as completed!");
            await loadTreksAndParticipants();
        }

        // EXPORT CSV
        window.exportCSV = function () {
            const headers = ["Registration ID", "Trek ID", "Trekker ID", "Status"];
            const rows = participants.map(p => [
                p.id, p.trek_id, p.trekker_id, p.status
            ]);

            const csvContent = [headers.join(","), ...rows.map(r => r.join(","))].join("\n");

            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "participants.csv";
            a.click();
        };

        initDashboard();

    </script>

</body>

</html>
