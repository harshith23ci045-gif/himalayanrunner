<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const supabase = createClient(
    'YOUR_SUPABASE_URL',
    'YOUR_SUPABASE_ANON_KEY'
  );

  async function handleRecovery() {
    const hash = window.location.hash.substring(1);
    const params = new URLSearchParams(hash);
    const accessToken = params.get('access_token');
    const refreshToken = params.get('refresh_token');
    const type = params.get('type');

    if (type !== 'recovery') {
      document.body.innerHTML = 'Invalid link.';
      return;
    }

    if (!accessToken) {
      document.body.innerHTML = 'Invalid or expired token.';
      return;
    }

    // Create session
    const { data, error } = await supabase.auth.setSession({
      access_token: accessToken,
      refresh_token: refreshToken
    });

    if (error) {
      document.body.innerHTML = 'Session error: ' + error.message;
      return;
    }

    // Render form
    document.body.innerHTML = `
      <input id="pwd" type="password" placeholder="New password" />
      <button id="update">Update Password</button>
    `;

    document.querySelector('#update').onclick = async () => {
      const newPassword = document.querySelector('#pwd').value;
      const { error } = await supabase.auth.updateUser({
        password: newPassword
      });
      if (error) {
        alert(error.message);
      } else {
        alert('Password updated.');
        window.location.href = '/login.html';
      }
    };
  }

  handleRecovery();
</script>
