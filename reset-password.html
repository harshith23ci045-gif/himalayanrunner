<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password</title>
  <link rel="stylesheet" href="/css/styles.css" />
</head>
<body>
  <main class="container">

    <h2 id="title">Reset Password</h2>

    <!-- Step 1: Request reset email -->
    <form id="requestForm" class="card">
      <label>Email</label>
      <input id="resetEmail" type="email" />
      <button type="submit" class="btn">Send reset email</button>
    </form>

    <!-- Step 2: User returned from email and can set new password -->
    <form id="updateForm" class="card" style="display:none;">
      <label>New Password</label>
      <input id="newPassword" type="password" minlength="6" required />
      <button type="submit" class="btn">Update Password</button>
    </form>

  </main>

  <script type="module">
    import { supabase } from "/js/supabase-client.js";

    const url = new URL(window.location.href);
    const type = url.searchParams.get("type");

    // DOM elements
    const requestForm = document.getElementById("requestForm");
    const updateForm = document.getElementById("updateForm");

    // If user clicked the email link â†’ show password update form
    if (type === "recovery") {
      requestForm.style.display = "none";
      updateForm.style.display = "block";
    }

    // STEP 1: send reset email
    requestForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("resetEmail").value.trim();

      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: "https://himalayanrunner.vercel.app/reset-password.html"
      });

      if (error) alert(error.message);
      else alert("Reset email sent!");
    });

    // STEP 2: user updates password after clicking email link
    updateForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const newPassword = document.getElementById("newPassword").value;

      const { error } = await supabase.auth.updateUser({ password: newPassword });

      if (error) {
        alert("Error: " + error.message);
        return;
      }

      alert("Password updated successfully!");
      window.location.href = "/login.html";
    });
  </script>
</body>
</html>
