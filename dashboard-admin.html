<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Himalayan Runners</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="loadingIndicator"
        style="position: fixed; top: 0; left: 0; right: 0; background: #1976d2; color: white; padding: 10px; text-align: center; z-index: 1000; display: none;">
        Loading dashboard...
    </div>

    <div class="container">
        <div class="dashboard-header" style="background: #333;">
            <h1>Admin Control Panel</h1>
            <button onclick="Auth.logout()" class="btn btn-outline"
                style="margin-top: 1rem; color: white; border-color: white;">Logout</button>
        </div>

        <div class="features">
            <div class="stat-card text-center" style="min-width: 150px;">
                <h3 id="totalUsers">0</h3>
                <p>Total Users</p>
            </div>
            <div class="stat-card text-center" style="min-width: 150px;">
                <h3 id="totalTreks">0</h3>
                <p>Total Treks</p>
            </div>
            <div class="stat-card text-center" style="min-width: 150px;">
                <h3 id="totalRegistrations">0</h3>
                <p>Registrations</p>
            </div>
        </div>

        <div class="glass-card mt-3">
            <h3>System Status</h3>
            <p>All systems operational.</p>
            <p>Database: <strong>Supabase Cloud</strong></p>
            <p>Connection: <span id="connectionStatus">Checking...</span></p>
        </div>
    </div>

        <script type="module">

        import { supabase } from "./js/supabase-client.js";
        import Auth from "./js/auth-handler.js"; 

        async function initDashboard() {
            const loader = document.getElementById('loadingIndicator');
            loader.style.display = 'block';

            try {
                // AUTH CHECK
                const user = await Auth.requireAuth();
                if (!user) return;

                if (user.role !== "Admin") {
                    alert("Access denied. Admins only.");
                    window.location.href = "index.html";
                    return;
                }

                // FETCH TOTAL USERS (profiles table)
                const { count: userCount } = await supabase
                    .from("profiles")
                    .select("*", { count: "exact", head: true });

                // FETCH TREKS
                const { count: trekCount } = await supabase
                    .from("treks")
                    .select("*", { count: "exact", head: true });

                // FETCH REGISTRATIONS
                const { count: regCount } = await supabase
                    .from("registrations")
                    .select("*", { count: "exact", head: true });

                // UPDATE UI
                document.getElementById("totalUsers").textContent = userCount ?? 0;
                document.getElementById("totalTreks").textContent = trekCount ?? 0;
                document.getElementById("totalRegistrations").textContent = regCount ?? 0;

                document.getElementById("connectionStatus").innerHTML =
                    '<span style="color: #4caf50;">✓ Connected</span>';

            } catch (err) {
                console.error(err);
                document.getElementById("connectionStatus").innerHTML =
                    '<span style="color: #f44336;">✗ Error</span>';
                alert("Error loading dashboard. Please try again.");
            }

            loader.style.display = 'none';
        }

        // INIT
        initDashboard();

    </script>
</body>
</html>
