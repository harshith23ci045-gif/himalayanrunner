<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Himalayan Runners</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="loadingIndicator"
        style="position: fixed; top: 0; left: 0; right: 0; background: #1976d2; color: white; padding: 10px; text-align: center; z-index: 1000; display: none;">
        Loading dashboard...
    </div>

    <div class="container">
        <div class="dashboard-header" style="background: #333;">
            <h1>Admin Control Panel</h1>
            <button onclick="Auth.logout()" class="btn btn-outline"
                style="margin-top: 1rem; color: white; border-color: white;">Logout</button>
        </div>

        <div class="features">
            <div class="stat-card text-center" style="min-width: 150px;">
                <h3 id="totalUsers">0</h3>
                <p>Total Users</p>
            </div>
            <div class="stat-card text-center" style="min-width: 150px;">
                <h3 id="totalTreks">0</h3>
                <p>Total Treks</p>
            </div>
            <div class="stat-card text-center" style="min-width: 150px;">
                <h3 id="totalRegistrations">0</h3>
                <p>Registrations</p>
            </div>
        </div>

        <div class="glass-card mt-3">
            <h3>System Status</h3>
            <p>All systems operational.</p>
            <p>Database: <strong>Supabase Cloud</strong></p>
            <p>Connection: <span id="connectionStatus">Checking...</span></p>
            <button onclick="clearData()" class="btn btn-accent mt-2">Clear All Data</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/db.js"></script>
    <script src="js/auth.js"></script>
    <script>
        async function initDashboard() {
            try {
                // Show loading indicator
                const loader = document.getElementById('loadingIndicator');
                loader.style.display = 'block';

                console.log('Initializing admin dashboard...');
                const user = await Auth.requireAuth();

                if (!user) {
                    console.log('No user found, redirecting to login');
                    return;
                }

                console.log('User loaded:', user);

                if (user.role !== 'Admin') {
                    console.log('User is not an admin, redirecting to index');
                    alert('Access denied. This page is for Administrators only.');
                    window.location.href = 'index.html';
                    return;
                }

                // Check connection and load data
                const users = await DB.getCollection('users');
                const treks = await DB.getCollection('treks');
                const registrations = await DB.getCollection('registrations');

                document.getElementById('totalUsers').textContent = users.length;
                document.getElementById('totalTreks').textContent = treks.length;
                document.getElementById('totalRegistrations').textContent = registrations.length;
                document.getElementById('connectionStatus').innerHTML = '<span style="color: #4caf50;">✓ Connected</span>';

                // Hide loading indicator
                loader.style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('connectionStatus').innerHTML = '<span style="color: #f44336;">✗ Error</span>';
                alert('Error loading dashboard data. Please check your connection.');
            }
        }

        async function clearData() {
            if (confirm('Are you sure you want to clear all data? This will delete ALL users, treks, and registrations from Supabase. This cannot be undone.')) {
                try {
                    // Delete all registrations
                    await supabase.from('registrations').delete().neq('id', '00000000-0000-0000-0000-000000000000');

                    // Delete all treks
                    await supabase.from('treks').delete().neq('id', '00000000-0000-0000-0000-000000000000');

                    // Delete all users
                    await supabase.from('users').delete().neq('id', '00000000-0000-0000-0000-000000000000');

                    alert('All data cleared. Reinitializing...');

                    // Reinitialize with seed data
                    await DB.seedInitialData();

                    sessionStorage.clear();
                    location.reload();
                } catch (error) {
                    console.error('Error clearing data:', error);
                    alert('Error clearing data. Check console for details.');
                }
            }
        }

        // Initialize dashboard
        initDashboard();
    </script>
</body>

</html>